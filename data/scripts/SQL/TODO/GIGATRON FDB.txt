SELECT
    P.COD_PRODUTO AS referencia,
    PAP.APELIDO AS gtin,
    P.DESC_PRODUTO AS nome,
    REPLACE(
        CAST(
            CAST(VISTA.PRECO AS NUMERIC(15,2))
        AS VARCHAR(30)), '.', ','
    ) AS valorVenda,
    GP.DESC_GRUPO AS observacao,
    p.COD_CLASS AS codigoNCM,
    p.COD_CEST AS codigoCEST,
    i.DESC_IMPOSTO AS idFiscal
FROM PRODUTOS P
    INNER JOIN PRODUTOS_GRADE PG ON (
        PG.COD_PRODUTO = P.COD_PRODUTO
    )
    INNER JOIN PRODUTOS_APELIDOS_PROD PAP ON (
        PAP.COD_PRODUTO = PG.COD_PRODUTO AND
        PAP.COD_GRADE = PG.COD_GRADE AND
        PAP.COD_APELIDO = 2
    )
    LEFT JOIN PRODUTOS_TAB_PRECOS_PROD VISTA ON (
        VISTA.COD_PRODUTO = PG.COD_PRODUTO AND
        VISTA.COD_GRADE = PG.COD_GRADE AND
        VISTA.COD_TABELA = 2
    )
    LEFT JOIN GRUPOS_PRODUTO GP
    ON P.COD_GRUPO = GP.COD_GRUPO
    LEFT JOIN IMPOSTOS i
    ON p.COD_IMPOSTO = i.COD_IMPOSTO
WHERE
    P.FLAG_ATIVO = 1 AND
    PG.FLAG_ATIVO = 1;